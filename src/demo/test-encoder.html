<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Hextile Engine Studio v1.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fflate/umd/index.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .container { background: #181818; padding: 25px; border-radius: 16px; width: 95%; max-width: 1100px; border: 1px solid #282828; }
        
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; }
        .panel { background: #222; padding: 20px; border-radius: 12px; border: 1px solid #333; }
        
        #drop-zone, #drop-zone-htl { border: 2px dashed #444; padding: 20px; text-align: center; cursor: pointer; border-radius: 8px; margin-bottom: 15px; transition: 0.2s; }
        #drop-zone:hover, #drop-zone-htl:hover { border-color: #007bff; background: #2a2a2a; }
        
        .controls { display: flex; flex-direction: column; gap: 15px; margin-bottom: 15px; }
        .preview-box { position: relative; background: #000; border-radius: 6px; overflow: hidden; border: 1px solid #111; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; }
        canvas { max-width: 100%; max-height: 100%; image-rendering: pixelated; }

        .stats { display: flex; gap: 10px; margin-top: 10px; }
        .stat-box { flex: 1; background: #111; padding: 8px; border-radius: 6px; text-align: center; font-size: 12px; }
        .stat-value { display: block; color: #00ff41; font-weight: bold; }

        button { width: 100%; padding: 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-blue { background: #007bff; color: white; }
        .btn-green { background: #28a745; color: white; }
        
        h2 { font-size: 16px; margin: 0 0 15px 0; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        pre { background: #000; padding: 10px; font-size: 10px; color: #666; overflow: hidden; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üïπÔ∏è Hextile Studio v1.1</h1>

    <div class="grid-layout">
        <div class="panel">
            <h2>–°–∂–∞—Ç–∏–µ (PNG ‚Üí HTL)</h2>
            <div id="drop-zone">–ö–∏–¥–∞–π PNG –¥–ª—è —Å–∂–∞—Ç–∏—è</div>
            <input type="file" id="file-input" accept="image/png" style="display: none;">
            
            <div class="controls">
                <label style="font-size: 12px;">–ö–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ: <b id="q-val">12</b></label>
                <input type="range" id="q-slider" min="1" max="64" value="12">
            </div>

            <div class="preview-box">
                <canvas id="orig-canvas"></canvas>
            </div>

            <div class="stats">
                <div class="stat-box">PNG <span id="s-png" class="stat-value">-</span></div>
                <div class="stat-box">HTL.GZ <span id="s-gz" class="stat-value">-</span></div>
            </div>

            <button id="dl-btn" class="btn-blue" style="display:none;">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –°–∫–∞—á–∞—Ç—å .htl.gz</button>
        </div>

        <div class="panel">
            <h2>–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ (HTL ‚Üí Canvas)</h2>
            <div id="drop-zone-htl">–ö–∏–¥–∞–π .htl.gz –¥–ª—è —Ç–µ—Å—Ç–∞</div>
            <input type="file" id="file-input-htl" accept=".gz" style="display: none;">

            <div class="controls">
                <select id="render-mode" style="background:#333; color:white; padding:8px; border:none; border-radius:4px;">
                    <option value="instant">–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞</option>
                    <option value="progressive">–ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º</option>
                </select>
            </div>

            <div class="preview-box">
                <canvas id="dest-canvas"></canvas>
            </div>

            <div class="stats">
                <div class="stat-box">–°—Ç–∞—Ç—É—Å <span id="d-status" class="stat-value">–û–∂–∏–¥–∞–Ω–∏–µ</span></div>
                <div class="stat-box">–í—Ä–µ–º—è <span id="d-time" class="stat-value">-</span></div>
            </div>
            
            <pre id="output">–ë–∏–Ω–∞—Ä–Ω—ã–π –ø–æ—Ç–æ–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</pre>
        </div>
    </div>
</div>

<script>
    let currentQuant = 12;
    let sourceImg = null;
    let debounceTimer;
    let lastBinaryData = null;

    // --- –°–õ–ê–ô–î–ï–† ---
    document.getElementById('q-slider').oninput = (e) => {
        currentQuant = parseInt(e.target.value);
        document.getElementById('q-val').innerText = currentQuant;
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => { if(sourceImg) updatePreview(); }, 150);
    };

    // --- –§–£–ù–ö–¶–ò–ò –°–ñ–ê–¢–ò–Ø ---
    function toHex(r, g, b) {
        const q = (c) => Math.round(c / currentQuant) * currentQuant;
        const h = (c) => Math.min(255, Math.max(0, q(c))).toString(16).padStart(2, '0');
        return (h(r) + h(g) + h(b)).toUpperCase();
    }

    function compressIndices(indices) {
        if (!indices.length) return "";
        indices.sort((a, b) => a - b);
        let res = indices[0].toString(36);
        for(let i=1; i<indices.length; i++) res += "," + (indices[i]-indices[i-1]).toString(36);
        return res;
    }

    // --- ENCODER LOGIC ---
    const dZone = document.getElementById('drop-zone');
    dZone.onclick = () => document.getElementById('file-input').click();
    document.getElementById('file-input').onchange = (e) => loadSource(e.target.files[0]);

    function loadSource(file) {
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => { 
                sourceImg = img; 
                document.getElementById('s-png').innerText = (file.size/1024).toFixed(1) + " KB";
                updatePreview(); 
            };
            img.src = e.target.result;
        }
        reader.readAsDataURL(file);
    }

    function updatePreview() {
        const canvas = document.getElementById('orig-canvas');
        // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
        const scale = Math.min(1, 800 / Math.max(sourceImg.width, sourceImg.height));
        canvas.width = sourceImg.width * scale;
        canvas.height = sourceImg.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(sourceImg, 0, 0, canvas.width, canvas.height);
        
        // --- –†–ê–°–ß–ï–¢ –ü–†–ò–ë–õ–ò–ó–ò–¢–ï–õ–¨–ù–û–ì–û –í–ï–°–ê ---
        const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        const map = new Map();
        for (let i = 0; i < pixels.length; i += 4) {
            if (pixels[i+3] < 128) continue;
            const hex = toHex(pixels[i], pixels[i+1], pixels[i+2]);
            if (!map.has(hex)) map.set(hex, []);
            map.get(hex).push(i/4);
        }

        const palette = Array.from(map.keys());
        let htlPreview = `INFO|${canvas.width}x${canvas.height}\nPALETTE|${palette.join(",")}\nDATA|`;
        
        // –î–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 50 —Ü–≤–µ—Ç–æ–≤ –≤ –ø—Ä–µ–≤—å—é
        palette.slice(0, 50).forEach((clr, idx) => {
            htlPreview += idx.toString(36) + ":" + compressIndices(map.get(clr)) + "|";
        });

        // –ë—ã—Å—Ç—Ä–æ–µ —Å–∂–∞—Ç–∏–µ (level 1) —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –≤–µ—Å–∞
        const previewBytes = new TextEncoder().encode(htlPreview);
        const compressedPreview = fflate.gzipSync(previewBytes, { level: 1 });
        
        // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –≤–µ—Å (—Ç–∞–∫ –∫–∞–∫ –ø—Ä–µ–≤—å—é –º–µ–Ω—å—à–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞, —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–ª–æ—â–∞–¥–∏)
        const areaRatio = (sourceImg.width * sourceImg.height) / (canvas.width * canvas.height);
        const estimatedSize = compressedPreview.length * areaRatio;

        document.getElementById('s-gz').innerText = "~" + (estimatedSize / 1024).toFixed(1) + " KB";
        document.getElementById('dl-btn').style.display = "block";
    }

    // –ì–ï–ù–ï–†–ê–¶–ò–Ø –§–ê–ô–õ–ê (–ß–µ—Å—Ç–Ω–∞—è, –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤)
    document.getElementById('dl-btn').onclick = () => {
        const canvas = document.createElement('canvas');
        canvas.width = sourceImg.width; canvas.height = sourceImg.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(sourceImg, 0, 0);
        const pixels = ctx.getImageData(0,0,canvas.width, canvas.height).data;
        
        const map = new Map();
        for(let i=0; i<pixels.length; i+=4) {
            if(pixels[i+3] < 128) continue;
            const hex = toHex(pixels[i], pixels[i+1], pixels[i+2]);
            if(!map.has(hex)) map.set(hex, []);
            map.get(hex).push(i/4);
        }

        const palette = Array.from(map.keys());
        let htl = `INFO|${canvas.width}x${canvas.height}\nPALETTE|${palette.join(",")}\nDATA|`;
        palette.forEach((clr, idx) => {
            htl += idx.toString(36) + ":" + compressIndices(map.get(clr)) + "|";
        });

        const compressed = fflate.gzipSync(new TextEncoder().encode(htl), { level: 9 });
        const blob = new Blob([compressed], { type: 'application/gzip' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "export.htl.gz";
        a.click();
        document.getElementById('s-gz').innerText = (compressed.length/1024).toFixed(1) + " KB";
    };

    // --- DECODER LOGIC ---
    const dZoneHtl = document.getElementById('drop-zone-htl');
    dZoneHtl.onclick = () => document.getElementById('file-input-htl').click();
    document.getElementById('file-input-htl').onchange = (e) => loadHtl(e.target.files[0]);

    function loadHtl(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            lastBinaryData = new Uint8Array(e.target.result);
            document.getElementById('output').innerText = "–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: " + file.name;
            runDecoder();
        };
        reader.readAsArrayBuffer(file);
    }

    async function runDecoder() {
        if(!lastBinaryData) return;
        const start = performance.now();
        document.getElementById('d-status').innerText = "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞...";

        try {
            const text = pako.ungzip(lastBinaryData, { to: 'string' });
            const [header, data] = text.split('DATA|');
            const info = header.split('\n')[0].split('|')[1].split('x');
            const pal = header.split('\n')[1].split('|')[1].split(',');
            const w = parseInt(info[0]), h = parseInt(info[1]);

            const canvas = document.getElementById('dest-canvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            const imgData = ctx.createImageData(w, h);
            const pix = imgData.data;
            const mode = document.getElementById('render-mode').value;

            const layers = data.split('|').filter(l => l.length > 0);
            for(let layer of layers) {
                const [pIdx36, indicesRaw] = layer.split(':');
                const color = pal[parseInt(pIdx36, 36)];
                const fullHex = color.length === 3 ? color[0]+color[0]+color[1]+color[1]+color[2]+color[2] : color;
                const r = parseInt(fullHex.slice(0,2), 16), g = parseInt(fullHex.slice(2,4), 16), b = parseInt(fullHex.slice(4,6), 16);
                
                let currentIdx = 0;
                indicesRaw.split(',').forEach(d => {
                    currentIdx += parseInt(d, 36);
                    const p = currentIdx * 4;
                    pix[p] = r; pix[p+1] = g; pix[p+2] = b; pix[p+3] = 255;
                });

                if(mode === 'progressive') {
                    ctx.putImageData(imgData, 0, 0);
                    await new Promise(r => setTimeout(r, 5));
                }
            }
            if(mode === 'instant') ctx.putImageData(imgData, 0, 0);
            
            document.getElementById('d-time').innerText = Math.round(performance.now() - start) + "ms";
            document.getElementById('d-status').innerText = "–ì–æ—Ç–æ–≤–æ";
        } catch(e) {
            alert("–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞: " + e.message);
        }
    }
</script>
</body>
</html>